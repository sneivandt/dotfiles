name: CI

on:
  pull_request:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # Rust formatting check
  rust-fmt:
    name: Rust Format
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --check --manifest-path cli/Cargo.toml

  # Rust linting
  rust-clippy:
    name: Rust Clippy
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            cli/target
          key: ${{ runner.os }}-cargo-clippy-${{ hashFiles('cli/Cargo.lock') }}

      - name: Run clippy
        run: cargo clippy --manifest-path cli/Cargo.toml -- -D warnings

  # Rust tests
  rust-test:
    name: Rust Tests
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            cli/target
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('cli/Cargo.lock') }}

      - name: Run tests
        run: cargo test --manifest-path cli/Cargo.toml

  # Build Linux binary
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            cli/target
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('cli/Cargo.lock') }}

      - name: Build release binary
        run: cargo build --release --manifest-path cli/Cargo.toml

      - name: Verify binary runs
        run: ./cli/target/release/dotfiles version

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: dotfiles-linux
          path: cli/target/release/dotfiles
          retention-days: 1

  # Build Windows binary
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            cli/target
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('cli/Cargo.lock') }}

      - name: Build release binary
        run: cargo build --release --manifest-path cli/Cargo.toml

      - name: Verify binary runs
        run: .\cli\target\release\dotfiles.exe version

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: dotfiles-windows
          path: cli/target/release/dotfiles.exe
          retention-days: 1

  # Configuration validation and INI file syntax checks
  validate-config:
    name: Validate Config - ${{ matrix.name }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - test: config_validation
            name: Configuration Consistency
          - test: symlinks_validation
            name: Symlinks References
          - test: chmod_validation
            name: File Permissions
          - test: ini_syntax
            name: INI Syntax
          - test: category_consistency
            name: Category Consistency
          - test: empty_sections
            name: Empty Sections Check
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Run ${{ matrix.name }}
        run: |
          DIR="$(pwd)"
          export DIR
          cd .github/workflows/scripts/linux
          . ./test-config.sh
          test_${{ matrix.test }}

  # Static analysis - shellcheck and PSScriptAnalyzer
  static-analysis:
    name: Static Analysis - ${{ matrix.tool }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - tool: shellcheck
            install_cmd: sudo apt-get update && sudo apt-get install -y shellcheck
            test_function: test_shellcheck
          - tool: PSScriptAnalyzer
            install_cmd: |
              sudo apt-get update
              sudo apt-get install -y wget apt-transport-https software-properties-common
              wget -q "https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb"
              sudo dpkg -i packages-microsoft-prod.deb
              sudo apt-get update
              sudo apt-get install -y powershell
            pwsh_install: true
            test_function: test_psscriptanalyzer
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install ${{ matrix.tool }}
        run: ${{ matrix.install_cmd }}

      - name: Install PSScriptAnalyzer module
        if: matrix.pwsh_install
        shell: pwsh
        run: Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Run ${{ matrix.tool }}
        run: |
          DIR="$(pwd)"
          export DIR
          cd .github/workflows/scripts/linux
          . ./test-static-analysis.sh
          ${{ matrix.test_function }}

  # Application tests
  test-applications:
    name: Test Application - ${{ matrix.application }}
    runs-on: ubuntu-latest
    needs: [build-linux]
    strategy:
      matrix:
        include:
          - application: git
            packages: git
            tests: config aliases behavior
          - application: zsh
            packages: zsh
            tests: completion
          - application: vim
            packages: vim
            tests: opens
          - application: nvim
            packages: neovim
            tests: opens plugins
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install ${{ matrix.packages }}
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.packages }}

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: dotfiles-linux
          path: bin/

      - name: Install base profile
        run: |
          chmod +x bin/dotfiles
          ./bin/dotfiles --root . -p base install -v

      - name: Run ${{ matrix.application }} tests
        run: |
          DIR="$(pwd)"
          export DIR
          cd .github/workflows/scripts/linux
          . ./test-applications.sh
          for test in ${{ matrix.tests }}; do
            test_${{ matrix.application }}_${test}
          done

  # Test paru (AUR helper) installation and functionality
  test-paru:
    name: Test Paru Installation
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install prerequisites in Arch container
        run: |
          # Use -Sy instead of -Syu to skip full system upgrade for speed
          # This is safe in CI as we use a fresh container each run
          pacman -Sy --noconfirm
          pacman -S --noconfirm base-devel git cargo sudo

      - name: Create test user (paru cannot run as root)
        run: |
          useradd -m -G wheel testuser
          echo "testuser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R testuser:testuser .

      - name: Run paru tests
        run: |
          REPO_DIR=$(pwd)
          chmod +x ./.github/workflows/scripts/linux/test-paru.sh
          su - testuser -c "cd \"$REPO_DIR\" && ./.github/workflows/scripts/linux/test-paru.sh \"$REPO_DIR\""

  # Script linting (thin wrappers)
  script-lint:
    name: Script Lint
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Run shellcheck
        run: shellcheck dotfiles.sh install.sh

  # Integration test: dry-run install for each Linux profile
  integration-linux:
    name: Integration - ${{ matrix.profile }}
    runs-on: ubuntu-latest
    needs: [build-linux]
    strategy:
      matrix:
        profile: [base, desktop]
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: dotfiles-linux
          path: bin/

      - name: Make binary executable
        run: chmod +x bin/dotfiles

      - name: Test dry-run install
        run: |
          ./bin/dotfiles --root . -p ${{ matrix.profile }} -d install

      - name: Test validation
        run: |
          ./bin/dotfiles --root . -p ${{ matrix.profile }} test

  # Integration test: Windows dry-run
  integration-windows:
    name: Integration - windows
    runs-on: windows-latest
    needs: [build-windows]
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: dotfiles-windows
          path: bin/

      - name: Test dry-run install
        run: |
          .\bin\dotfiles.exe --root . -p windows -d install

  # Test Docker build
  test-docker:
    name: Test Docker Build
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t dotfiles-test .

      - name: Run container smoke test
        run: |
          docker run --rm dotfiles-test sh -c "command -v zsh && echo 'Smoke test passed'"

  # Test git hooks
  test-git-hooks:
    name: Test Git Hooks
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Configure git
        run: |
          git config user.name "CI Test"
          git config user.email "ci@test.local"

      - name: Install git hooks
        run: |
          ln -sf "$(pwd)/hooks/pre-commit" .git/hooks/pre-commit
          chmod +x .git/hooks/pre-commit

      - name: Run pre-commit hook tests
        run: ./.github/workflows/scripts/linux/test-git-hooks.sh

  # Test shell wrapper functionality on Linux
  test-shell-wrapper-linux:
    name: Test Shell Wrapper (Linux)
    runs-on: ubuntu-latest
    needs: [build-linux]
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: dotfiles-linux
          path: bin/

      - name: Make binary executable
        run: chmod +x bin/dotfiles

      - name: Run shell wrapper tests
        run: |
          DIR="$(pwd)"
          BINARY_PATH="$(pwd)/bin/dotfiles"
          export DIR BINARY_PATH
          cd .github/workflows/scripts/linux
          . ./test-shell-wrapper.sh
          test_wrapper_build_mode
          test_wrapper_version_cache
          test_wrapper_uses_local_binary
          test_wrapper_checksum_verification
          test_wrapper_offline_fallback
          test_wrapper_forwarded_args
          test_wrapper_root_detection
          test_wrapper_error_handling

  # Test shell wrapper functionality on Windows
  test-shell-wrapper-windows:
    name: Test Shell Wrapper (Windows)
    runs-on: windows-latest
    needs: [build-windows]
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: dotfiles-windows
          path: bin/

      - name: Run PowerShell wrapper tests
        shell: pwsh
        run: |
          $env:BINARY_PATH = Join-Path $PWD "bin\dotfiles.exe"
          & .github/workflows/scripts/windows/Test-ShellWrapper.ps1

  # Test downloading and running binary from artifact (simulates release flow)
  test-artifact-download-flow:
    name: Test Artifact Download Flow
    runs-on: ubuntu-latest
    needs: [build-linux]
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Download Linux binary artifact
        uses: actions/download-artifact@v4
        with:
          name: dotfiles-linux
          path: downloaded/

      - name: Verify downloaded binary is executable
        run: |
          chmod +x downloaded/dotfiles
          if [ ! -x "downloaded/dotfiles" ]; then
            echo "ERROR: Downloaded binary is not executable"
            exit 1
          fi

      - name: Test binary runs version command
        run: |
          output=$(downloaded/dotfiles version)
          echo "Version output: $output"
          if ! echo "$output" | grep -q "dotfiles"; then
            echo "ERROR: Binary version command failed"
            exit 1
          fi

      - name: Test binary runs with --help
        run: |
          downloaded/dotfiles --help

      - name: Test binary runs dry-run install
        run: |
          downloaded/dotfiles --root . -p base -d install

      - name: Test binary runs test command
        run: |
          downloaded/dotfiles --root . -p base test

  # Summary job
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs:
      - rust-fmt
      - rust-clippy
      - rust-test
      - build-linux
      - build-windows
      - script-lint
      - static-analysis
      - validate-config
      - test-applications
      - test-paru
      - integration-linux
      - integration-windows
      - test-docker
      - test-git-hooks
      - test-shell-wrapper-linux
      - test-shell-wrapper-windows
      - test-artifact-download-flow
    steps:
      - name: Mark CI as successful
        run: echo "All CI jobs passed"
