name: CI

on:
  pull_request:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # ── Rust Code Quality ─────────────────────────────────
  rust:
    name: "Rust: ${{ matrix.name }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Check Formatting
            command: cargo fmt --check --manifest-path cli/Cargo.toml
            cache_key: fmt
          - name: Lint with Clippy
            command: cargo clippy --manifest-path cli/Cargo.toml --all-targets -- -D warnings
            cache_key: clippy
          - name: Run Tests
            command: cargo test --manifest-path cli/Cargo.toml
            cache_key: test
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            cli/target
          key: ${{ runner.os }}-cargo-${{ matrix.cache_key }}-${{ hashFiles('cli/Cargo.lock') }}
      - run: ${{ matrix.command }}

  # ── Script Linting ────────────────────────────────────
  lint:
    name: "Lint: ${{ matrix.name }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: ShellCheck
            setup: sudo apt-get update && sudo apt-get install -y shellcheck
            test_function: test_shellcheck
          - name: PSScriptAnalyzer
            setup: pwsh -NoProfile -Command "Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser"
            test_function: test_psscriptanalyzer
    steps:
      - uses: actions/checkout@v4
      - name: Install ${{ matrix.name }}
        run: ${{ matrix.setup }}
      - name: Run ${{ matrix.name }}
        run: |
          export DIR="$(pwd)"
          cd .github/workflows/scripts/linux
          sh test-static-analysis.sh ${{ matrix.test_function }}

  # ── Configuration Validation ──────────────────────────
  validate-config:
    name: "Config: ${{ matrix.name }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Manifest File References
            test: config_validation
          - name: Symlink File References
            test: symlinks_validation
          - name: File Permission References
            test: chmod_validation
          - name: INI File Syntax
            test: ini_syntax
          - name: Category Consistency
            test: category_consistency
          - name: No Empty Sections
            test: empty_sections
    steps:
      - uses: actions/checkout@v4
      - name: Validate ${{ matrix.name }}
        run: |
          export DIR="$(pwd)"
          cd .github/workflows/scripts/linux
          sh test-config.sh ${{ matrix.test }}

  # ── Build ─────────────────────────────────────────────
  build:
    name: "Build: ${{ matrix.os_name }} Binary"
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            os_name: Linux
            artifact: dotfiles-linux
            binary_name: dotfiles
          - runner: windows-latest
            os_name: Windows
            artifact: dotfiles-windows
            binary_name: dotfiles.exe
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            cli/target
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('cli/Cargo.lock') }}
      - name: Build release binary
        run: cargo build --release --manifest-path cli/Cargo.toml
      - name: Verify binary
        shell: bash
        run: ./cli/target/release/${{ matrix.binary_name }} version
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: cli/target/release/${{ matrix.binary_name }}
          retention-days: 1

  # ── Integration Tests ─────────────────────────────────
  integration:
    name: "Integration: ${{ matrix.profile }} on ${{ matrix.os_name }}"
    runs-on: ${{ matrix.runner }}
    needs: [build]
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            os_name: Linux
            artifact: dotfiles-linux
            binary_name: dotfiles
            profile: base
          - runner: ubuntu-latest
            os_name: Linux
            artifact: dotfiles-linux
            binary_name: dotfiles
            profile: desktop
          - runner: windows-latest
            os_name: Windows
            artifact: dotfiles-windows
            binary_name: dotfiles.exe
            profile: base
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: bin/
      - name: Make binary executable
        if: runner.os == 'Linux'
        run: chmod +x bin/${{ matrix.binary_name }}
      - name: Dry-run install
        shell: bash
        run: ./bin/${{ matrix.binary_name }} --root . -p ${{ matrix.profile }} -d install
      - name: Run validation
        if: runner.os == 'Linux'
        shell: bash
        run: ./bin/${{ matrix.binary_name }} --root . -p ${{ matrix.profile }} test

  test-install-uninstall:
    name: "Integration: Install/Uninstall round-trip"
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: dotfiles-linux
          path: bin/
      - name: Run install/uninstall round-trip test
        run: |
          chmod +x bin/dotfiles
          export DIR="$(pwd)" BINARY_PATH="$(pwd)/bin/dotfiles"
          cd .github/workflows/scripts/linux
          sh test-uninstall.sh

  # ── Application Tests ─────────────────────────────────
  test-applications:
    name: "App: ${{ matrix.application }}"
    runs-on: ubuntu-latest
    needs: [build]
    strategy:
      fail-fast: false
      matrix:
        include:
          - application: git
            packages: git
            tests: config aliases behavior
          - application: zsh
            packages: zsh
            tests: completion
          - application: vim
            packages: vim
            tests: opens
          - application: nvim
            packages: neovim
            tests: opens plugins
    steps:
      - uses: actions/checkout@v4
      - name: Install ${{ matrix.packages }}
        run: sudo apt-get update && sudo apt-get install -y ${{ matrix.packages }}
      - uses: actions/download-artifact@v4
        with:
          name: dotfiles-linux
          path: bin/
      - name: Install dotfiles with base profile
        run: |
          chmod +x bin/dotfiles
          ./bin/dotfiles --root . -p base install -v
      - name: Test ${{ matrix.application }}
        run: |
          export DIR="$(pwd)"
          cd .github/workflows/scripts/linux
          sh test-applications.sh ${{ matrix.application }} ${{ matrix.tests }}

  # ── Specialized Tests ─────────────────────────────────
  test-paru:
    name: "Arch Linux: Paru AUR Helper"
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - uses: actions/checkout@v4
      - name: Install prerequisites
        run: |
          # -Sy (not -Syu) skips full upgrade; safe in ephemeral CI containers
          pacman -Sy --noconfirm
          pacman -S --noconfirm base-devel git cargo sudo
      - name: Create non-root test user
        run: |
          useradd -m -G wheel testuser
          echo "testuser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R testuser:testuser .
      - name: Run paru tests
        run: |
          REPO_DIR=$(pwd)
          chmod +x .github/workflows/scripts/linux/test-paru.sh
          su - testuser -c "cd \"$REPO_DIR\" && ./.github/workflows/scripts/linux/test-paru.sh \"$REPO_DIR\""

  test-docker:
    name: "Docker: Build Image and Smoke Test"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build and test Docker image
        run: |
          docker build -t dotfiles-test .
          docker run --rm dotfiles-test sh -c "command -v zsh && echo 'Smoke test passed'"

  test-git-hooks:
    name: "Security: Pre-commit Sensitive Data Detection"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install and test pre-commit hook
        run: |
          git config user.name "CI Test"
          git config user.email "ci@test.local"
          ln -sf "$(pwd)/hooks/pre-commit" .git/hooks/pre-commit
          chmod +x .git/hooks/pre-commit
          .github/workflows/scripts/linux/test-git-hooks.sh

  test-shell-wrapper-linux:
    name: "Shell Wrapper: Linux (dotfiles.sh)"
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: dotfiles-linux
          path: bin/
      - name: Run shell wrapper tests
        run: |
          chmod +x bin/dotfiles
          export DIR="$(pwd)" BINARY_PATH="$(pwd)/bin/dotfiles"
          cd .github/workflows/scripts/linux
          sh test-shell-wrapper.sh

  test-shell-wrapper-windows:
    name: "Shell Wrapper: Windows (dotfiles.ps1)"
    runs-on: windows-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: dotfiles-windows
          path: bin/
      - name: Run PowerShell wrapper tests
        shell: pwsh
        run: |
          $env:BINARY_PATH = Join-Path $PWD "bin\dotfiles.exe"
          & .github/workflows/scripts/windows/Test-ShellWrapper.ps1

  # ── CI Gate ───────────────────────────────────────────
  ci-success:
    name: "All CI Checks Passed"
    runs-on: ubuntu-latest
    needs:
      - rust
      - lint
      - validate-config
      - build
      - integration
      - test-install-uninstall
      - test-applications
      - test-paru
      - test-docker
      - test-git-hooks
      - test-shell-wrapper-linux
      - test-shell-wrapper-windows
    steps:
      - run: echo "All CI jobs passed"
