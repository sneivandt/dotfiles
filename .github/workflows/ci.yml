name: CI

on:
  pull_request:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # Configuration validation and INI file syntax checks
  validate-config:
    name: Validate Config - ${{ matrix.name }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - test: config_validation
            name: Configuration Consistency
          - test: symlinks_validation
            name: Symlinks References
          - test: chmod_validation
            name: File Permissions
          - test: ini_syntax
            name: INI Syntax
          - test: category_consistency
            name: Category Consistency
          - test: empty_sections
            name: Empty Sections Check
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Run ${{ matrix.name }}
        run: |
          DIR="$(pwd)"
          export DIR
          export OPT=""
          . ./src/linux/logger.sh
          . ./src/linux/utils.sh
          . ./test/linux/test-config.sh
          test_${{ matrix.test }}

  # Static analysis - shellcheck and PSScriptAnalyzer
  static-analysis:
    name: Static Analysis - ${{ matrix.tool }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - tool: shellcheck
            install_cmd: sudo apt-get update && sudo apt-get install -y shellcheck
            test_function: test_shellcheck
          - tool: PSScriptAnalyzer
            install_cmd: |
              sudo apt-get update
              sudo apt-get install -y wget apt-transport-https software-properties-common
              wget -q "https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb"
              sudo dpkg -i packages-microsoft-prod.deb
              sudo apt-get update
              sudo apt-get install -y powershell
            pwsh_install: true
            test_function: test_psscriptanalyzer
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install ${{ matrix.tool }}
        run: ${{ matrix.install_cmd }}

      - name: Install PSScriptAnalyzer module
        if: matrix.pwsh_install
        shell: pwsh
        run: Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Run ${{ matrix.tool }}
        run: |
          DIR="$(pwd)"
          export DIR
          export OPT=""
          . ./src/linux/logger.sh
          . ./src/linux/utils.sh
          . ./test/linux/test-static-analysis.sh
          ${{ matrix.test_function }}

  # Application tests
  test-applications:
    name: Test Application - ${{ matrix.application }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - application: git
            packages: git
            tests: config aliases behavior
          - application: zsh
            packages: zsh
            tests: completion
          - application: vim
            packages: vim
            tests: opens
          - application: nvim
            packages: neovim
            tests: opens plugins
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install ${{ matrix.packages }}
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.packages }}

      - name: Install base profile
        run: |
          ./dotfiles.sh --install --profile base -v

      - name: Run ${{ matrix.application }} tests
        run: |
          DIR="$(pwd)"
          export DIR
          export OPT=""
          . ./src/linux/logger.sh
          . ./src/linux/utils.sh
          . ./.github/workflows/scripts/linux/test-applications.sh
          for test in ${{ matrix.tests }}; do
            test_${{ matrix.application }}_${test}
          done

  # Test Linux profiles
  test-linux-profiles:
    name: Test Linux - ${{ matrix.profile }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - profile: base
            skip_os: false
          - profile: arch
            skip_os: true
          - profile: arch-desktop
            skip_os: true
          - profile: desktop
            skip_os: false
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Test dry-run installation
        run: |
          SKIP_OS_FLAG="${{ matrix.skip_os && '--skip-os-detection' || '' }}"
          ./dotfiles.sh --install --profile ${{ matrix.profile }} --dry-run $SKIP_OS_FLAG -v 2>&1 | tee ${{ matrix.profile }}-output.log

      - name: Verify sparse checkout configuration
        run: ./.github/workflows/scripts/verify/verify-sparse-checkout.sh

      - name: Verify profile-specific symlinks
        run: ./.github/workflows/scripts/verify/verify-profile.sh ${{ matrix.profile }} ${{ matrix.profile }}-output.log

      - name: Test profile idempotency
        run: |
          DIR="$(pwd)"
          export DIR
          export OPT=""
          SKIP_OS_FLAG="${{ matrix.skip_os && '--skip-os-detection' || '' }}"
          . ./src/linux/logger.sh
          . ./src/linux/utils.sh
          . ./.github/workflows/scripts/linux/test-idempotency.sh
          test_idempotency_install_${{ matrix.profile == 'arch-desktop' && 'arch_desktop' || matrix.profile }} $SKIP_OS_FLAG

      - name: Run actual installation
        run: |
          SKIP_OS_FLAG="${{ matrix.skip_os && '--skip-os-detection' || '' }}"
          ./dotfiles.sh --install --profile ${{ matrix.profile }} $SKIP_OS_FLAG -v

      - name: Test dry-run uninstall
        run: |
          ./dotfiles.sh --uninstall --profile ${{ matrix.profile }} --dry-run -v 2>&1 | tee uninstall-output.log

      - name: Verify dry-run uninstall assertions
        run: ./.github/workflows/scripts/verify/verify-uninstall.sh uninstall-output.log

  # Test paru (AUR helper) installation and functionality
  test-paru:
    name: Test Paru Installation
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install prerequisites in Arch container
        run: |
          # Use -Sy instead of -Syu to skip full system upgrade for speed
          # This is safe in CI as we use a fresh container each run
          pacman -Sy --noconfirm
          pacman -S --noconfirm base-devel git sudo

      - name: Create test user (paru cannot run as root)
        run: |
          useradd -m -G wheel testuser
          echo "testuser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R testuser:testuser .

      - name: Run paru tests
        run: |
          REPO_DIR=$(pwd)
          chmod +x ./.github/workflows/scripts/linux/run-paru-tests.sh
          su - testuser -c "cd \"$REPO_DIR\" && ./.github/workflows/scripts/linux/run-paru-tests.sh \"$REPO_DIR\""

  # Test Windows profile
  test-windows:
    name: Test Windows
    runs-on: windows-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Run PowerShell script analysis
        shell: pwsh
        run: |
          Import-Module .\test\windows\Test.psm1
          Test-PSScriptAnalyzer -dir $PWD

      - name: Test Windows modules
        shell: pwsh
        run: ./.github/workflows/scripts/windows/Test-Modules.ps1

      - name: Test Dotfiles PowerShell module
        shell: pwsh
        run: ./.github/workflows/scripts/windows/Test-DotfilesModule.ps1

      - name: Verify Windows configuration
        shell: pwsh
        run: ./.github/workflows/scripts/windows/Test-Configuration.ps1

      - name: Test dry-run installation (PowerShell Core)
        shell: pwsh
        run: |
          $VerbosePreference = 'Continue'
          .\dotfiles.ps1 -DryRun -Verbose 2>&1 | Tee-Object -FilePath windows-output.log

      - name: Verify Windows profile symlinks
        shell: pwsh
        run: |
          $output = Get-Content windows-output.log
          if (-not ($output -match "DRY")) {
            Write-Error "Expected dry-run output"
            exit 1
          }
          Write-Output "âœ“ Dry-run test passed for Windows profile"

  # Test pre-commit hooks
  test-git-hooks:
    name: Test Git Hooks
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Configure git
        run: |
          git config user.name "CI Test"
          git config user.email "ci@test.local"

      - name: Install git hooks
        run: |
          ln -sf "$(pwd)/hooks/pre-commit" .git/hooks/pre-commit
          chmod +x .git/hooks/pre-commit

      - name: Run pre-commit hook tests
        run: ./test/linux/test-git-hooks.sh

  # Test Docker image build
  test-docker:
    name: Test Docker Build
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t dotfiles-test .

      - name: Run container smoke test
        run: |
          docker run --rm dotfiles-test sh -c "command -v zsh && echo 'Smoke test passed'"

  # Summary job - require only this one in branch protection
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs:
      - static-analysis
      - test-applications
      - test-docker
      - test-git-hooks
      - test-linux-profiles
      - test-paru
      - test-windows
      - validate-config
    steps:
      - name: Mark CI as successful
        run: echo "All CI jobs passed"
