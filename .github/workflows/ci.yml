name: CI

on:
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  # Configuration validation and INI file syntax checks
  validate-config:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Run configuration validation tests
        run: |
          DIR="$(pwd)"
          export DIR
          export OPT=""
          . ./src/linux/logger.sh
          . ./src/linux/utils.sh
          . ./test/linux/test-config.sh
          test_config_validation
          test_symlinks_validation
          test_chmod_validation
          test_ini_syntax
          test_category_consistency
          test_empty_sections

  # Static analysis - shellcheck and PSScriptAnalyzer
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Install PowerShell Core
        run: |
          sudo apt-get install -y wget apt-transport-https software-properties-common
          wget -q "https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb"
          sudo dpkg -i packages-microsoft-prod.deb
          sudo apt-get update
          sudo apt-get install -y powershell

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Run shellcheck
        run: |
          # Source the test file and run shellcheck directly
          DIR="$(pwd)"
          export DIR
          export OPT=""
          . ./src/linux/logger.sh
          . ./src/linux/utils.sh
          . ./test/linux/test-static-analysis.sh
          test_shellcheck

      - name: Run PSScriptAnalyzer
        run: |
          # Source the test file and run PSScriptAnalyzer directly
          DIR="$(pwd)"
          export DIR
          export OPT=""
          . ./src/linux/logger.sh
          . ./src/linux/utils.sh
          . ./test/linux/test-static-analysis.sh
          test_psscriptanalyzer

  # Application tests - vim, nvim, zsh
  test-applications:
    name: Test Applications
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install vim, neovim, and zsh
        run: |
          sudo apt-get update
          sudo apt-get install -y vim neovim zsh

      - name: Install base profile
        run: |
          ./dotfiles.sh --install --profile base -v

      - name: Run application tests
        run: |
          DIR="$(pwd)"
          export DIR
          export OPT=""
          . ./src/linux/logger.sh
          . ./src/linux/utils.sh
          . ./test/linux/test-applications.sh
          test_zsh_completion
          test_vim_opens
          test_nvim_opens
          test_nvim_plugins

      - name: Run idempotency tests
        run: |
          DIR="$(pwd)"
          export DIR
          export OPT=""
          export PROFILE="base"
          . ./src/linux/logger.sh
          . ./src/linux/utils.sh
          . ./test/linux/test-idempotency.sh
          test_idempotency_symlinks

  # Test base profile on Linux (minimal configuration)
  test-linux-base:
    name: Test Linux - Base Profile
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Test dry-run installation
        run: |
          ./dotfiles.sh --install --profile base --dry-run -v 2>&1 | tee base-output.log

      - name: Verify profile-specific symlinks
        run: ./.github/workflows/scripts/verify/verify-profile.sh base base-output.log

  # Test arch profile on Linux (headless Arch-focused)
  test-linux-arch:
    name: Test Linux - Arch Profile
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Test dry-run installation
        run: |
          ./dotfiles.sh --install --profile arch --dry-run --skip-os-detection -v 2>&1 | tee arch-output.log

      - name: Verify sparse checkout configuration
        run: ./.github/workflows/scripts/verify/verify-sparse-checkout.sh

      - name: Verify profile-specific symlinks
        run: ./.github/workflows/scripts/verify/verify-profile.sh arch arch-output.log

  # Test arch-desktop profile on Linux (full desktop environment)
  test-linux-arch-desktop:
    name: Test Linux - Arch Desktop Profile
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Test dry-run installation
        run: |
          ./dotfiles.sh --install --profile arch-desktop --dry-run --skip-os-detection -v 2>&1 | tee arch-desktop-output.log

      - name: Verify sparse checkout excludes Windows files
        run: ./.github/workflows/scripts/verify/verify-sparse-checkout-excludes-windows.sh

      - name: Verify profile-specific symlinks
        run: ./.github/workflows/scripts/verify/verify-profile.sh arch-desktop arch-desktop-output.log

  # Test idempotency - install profiles twice to verify no errors
  test-linux-idempotency:
    name: Test Linux - Idempotency
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Test base profile idempotency
        run: |
          echo "=== First installation ==="
          ./dotfiles.sh --install --profile base -v
          echo "=== Second installation (should be idempotent) ==="
          ./dotfiles.sh --install --profile base -v

      - name: Test arch profile idempotency
        run: |
          echo "=== First installation ==="
          ./dotfiles.sh --install --profile arch --skip-os-detection -v
          echo "=== Second installation (should be idempotent) ==="
          ./dotfiles.sh --install --profile arch --skip-os-detection -v

      - name: Test arch-desktop profile idempotency
        run: |
          echo "=== First installation ==="
          ./dotfiles.sh --install --profile arch-desktop --skip-os-detection -v
          echo "=== Second installation (should be idempotent) ==="
          ./dotfiles.sh --install --profile arch-desktop --skip-os-detection -v

  # Test uninstall functionality
  test-linux-uninstall:
    name: Test Linux - Uninstall
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Run actual installation first
        run: |
          ./dotfiles.sh --install --profile base -v

      - name: Test dry-run uninstall
        run: |
          ./dotfiles.sh --uninstall --profile base --dry-run -v 2>&1 | tee uninstall-output.log

      - name: Verify dry-run assertions
        run: ./.github/workflows/scripts/verify/verify-uninstall.sh uninstall-output.log

  # Test Windows profile
  test-windows:
    name: Test Windows - Windows Profile
    runs-on: windows-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Run PowerShell script analysis
        shell: pwsh
        run: |
          Import-Module .\test\windows\Test.psm1
          Test-PSScriptAnalyzer -dir $PWD

      - name: Test Windows modules
        shell: pwsh
        run: ./.github/workflows/scripts/windows/Test-Modules.ps1

      - name: Verify Windows configuration
        shell: pwsh
        run: ./.github/workflows/scripts/windows/Test-Configuration.ps1

  # Test Windows idempotency
  test-windows-idempotency:
    name: Test Windows - Idempotency
    runs-on: windows-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Test Windows profile idempotency
        shell: pwsh
        run: |
          Import-Module .\test\windows\Test.psm1
          if (-not (Test-IdempotencyInstall -Profile "windows" -Verbose)) {
            Write-Error "Windows idempotency test failed"
            exit 1
          }

  # Compare profiles to ensure they produce different outputs
  test-profile-differences:
    name: Test Profile Differences
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Run all profiles and extract symlinks
        run: |
          ./dotfiles.sh --install --profile base --dry-run --skip-os-detection -v 2>&1 | tee base-full.log
          ./dotfiles.sh --install --profile arch --dry-run --skip-os-detection -v 2>&1 | tee arch-full.log
          ./dotfiles.sh --install --profile arch-desktop --dry-run --skip-os-detection -v 2>&1 | tee arch-desktop-full.log

          # Extract only symlink-related operations for comparison
          grep "Would link" base-full.log | sort > base-symlinks.log || true
          grep "Would link" arch-full.log | sort > arch-symlinks.log || true
          grep "Would link" arch-desktop-full.log | sort > arch-desktop-symlinks.log || true

      - name: Verify profiles link different files
        run: ./.github/workflows/scripts/verify/verify-profile-differences.sh

  # Test Docker image build
  test-docker:
    name: Test Docker Build
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t dotfiles-test .

      - name: Run container smoke test
        run: |
          docker run --rm dotfiles-test sh -c "command -v zsh && echo 'Smoke test passed'"
