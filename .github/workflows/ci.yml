name: CI

on:
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  # Configuration validation and INI file syntax checks
  validate-config:
    name: Validate Config - ${{ matrix.test }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test:
          - config_validation
          - symlinks_validation
          - chmod_validation
          - ini_syntax
          - category_consistency
          - empty_sections
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Run ${{ matrix.test }}
        run: |
          DIR="$(pwd)"
          export DIR
          export OPT=""
          . ./src/linux/logger.sh
          . ./src/linux/utils.sh
          . ./test/linux/test-config.sh
          test_${{ matrix.test }}

  # Static analysis - shellcheck and PSScriptAnalyzer
  static-analysis:
    name: Static Analysis - ${{ matrix.tool }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - tool: shellcheck
            install_cmd: sudo apt-get update && sudo apt-get install -y shellcheck
            test_function: test_shellcheck
          - tool: PSScriptAnalyzer
            install_cmd: |
              sudo apt-get update
              sudo apt-get install -y wget apt-transport-https software-properties-common
              wget -q "https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb"
              sudo dpkg -i packages-microsoft-prod.deb
              sudo apt-get update
              sudo apt-get install -y powershell
            pwsh_install: true
            test_function: test_psscriptanalyzer
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install ${{ matrix.tool }}
        run: ${{ matrix.install_cmd }}

      - name: Install PSScriptAnalyzer module
        if: matrix.pwsh_install
        shell: pwsh
        run: Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Run ${{ matrix.tool }}
        run: |
          DIR="$(pwd)"
          export DIR
          export OPT=""
          . ./src/linux/logger.sh
          . ./src/linux/utils.sh
          . ./test/linux/test-static-analysis.sh
          ${{ matrix.test_function }}

  # Application tests - vim, nvim, zsh
  test-applications:
    name: Test Applications
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install vim, neovim, and zsh
        run: |
          sudo apt-get update
          sudo apt-get install -y vim neovim zsh

      - name: Install base profile
        run: |
          ./dotfiles.sh --install --profile base -v

      - name: Run application tests
        run: |
          DIR="$(pwd)"
          export DIR
          export OPT=""
          . ./src/linux/logger.sh
          . ./src/linux/utils.sh
          . ./.github/workflows/scripts/linux/test-applications.sh
          test_zsh_completion
          test_vim_opens
          test_nvim_opens
          test_nvim_plugins

      - name: Run idempotency tests
        run: |
          DIR="$(pwd)"
          export DIR
          export OPT=""
          export PROFILE="base"
          . ./src/linux/logger.sh
          . ./src/linux/utils.sh
          . ./.github/workflows/scripts/linux/test-idempotency.sh
          test_idempotency_symlinks

  # Test profile installations with dry-run (matrix for all profiles)
  test-linux-profiles:
    name: Test Linux - ${{ matrix.profile }} Profile
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - profile: base
            skip_os: false
            verify_script: verify-profile.sh
          - profile: arch
            skip_os: true
            verify_script: verify-profile.sh
            extra_verify: verify-sparse-checkout.sh
          - profile: arch-desktop
            skip_os: true
            verify_script: verify-profile.sh
            extra_verify: verify-sparse-checkout-excludes-windows.sh
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Test dry-run installation
        run: |
          SKIP_OS_FLAG="${{ matrix.skip_os == 'true' && '--skip-os-detection' || '' }}"
          ./dotfiles.sh --install --profile ${{ matrix.profile }} --dry-run $SKIP_OS_FLAG -v 2>&1 | tee ${{ matrix.profile }}-output.log

      - name: Run extra verification
        if: matrix.extra_verify
        run: ./.github/workflows/scripts/verify/${{ matrix.extra_verify }}

      - name: Verify profile-specific symlinks
        run: ./.github/workflows/scripts/verify/${{ matrix.verify_script }} ${{ matrix.profile }} ${{ matrix.profile }}-output.log

  # Test idempotency - install profiles twice to verify no errors (matrix for all profiles)
  test-linux-idempotency:
    name: Test Linux - ${{ matrix.profile }} Idempotency
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - profile: base
            skip_os: false
          - profile: arch
            skip_os: true
          - profile: arch-desktop
            skip_os: true
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Test profile idempotency
        run: |
          SKIP_OS_FLAG="${{ matrix.skip_os == 'true' && '--skip-os-detection' || '' }}"
          echo "=== First installation ==="
          ./dotfiles.sh --install --profile ${{ matrix.profile }} $SKIP_OS_FLAG -v
          echo "=== Second installation (should be idempotent) ==="
          ./dotfiles.sh --install --profile ${{ matrix.profile }} $SKIP_OS_FLAG -v

  # Test uninstall functionality
  test-linux-uninstall:
    name: Test Linux - Uninstall
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Run actual installation first
        run: |
          ./dotfiles.sh --install --profile base -v

      - name: Test dry-run uninstall
        run: |
          ./dotfiles.sh --uninstall --profile base --dry-run -v 2>&1 | tee uninstall-output.log

      - name: Verify dry-run assertions
        run: ./.github/workflows/scripts/verify/verify-uninstall.sh uninstall-output.log

  # Test Windows profile
  test-windows:
    name: Test Windows - Windows Profile
    runs-on: windows-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Run PowerShell script analysis
        shell: pwsh
        run: |
          Import-Module .\test\windows\Test.psm1
          Test-PSScriptAnalyzer -dir $PWD

      - name: Test Windows modules
        shell: pwsh
        run: ./.github/workflows/scripts/windows/Test-Modules.ps1

      - name: Verify Windows configuration
        shell: pwsh
        run: ./.github/workflows/scripts/windows/Test-Configuration.ps1

      - name: Test dry-run installation (PowerShell Core)
        shell: pwsh
        run: |
          $VerbosePreference = 'Continue'
          .\dotfiles.ps1 -DryRun -Verbose 2>&1 | Tee-Object -FilePath windows-output.log

      - name: Verify Windows profile symlinks
        shell: pwsh
        run: |
          $output = Get-Content windows-output.log
          if (-not ($output -match "DRY-RUN")) {
            Write-Error "Expected dry-run output"
            exit 1
          }
          Write-Output "âœ“ Dry-run test passed for Windows profile"

  # Compare profiles to ensure they produce different outputs
  test-profile-differences:
    name: Test Profile Differences
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Run all profiles and extract symlinks
        run: |
          ./dotfiles.sh --install --profile base --dry-run --skip-os-detection -v 2>&1 | tee base-full.log
          ./dotfiles.sh --install --profile arch --dry-run --skip-os-detection -v 2>&1 | tee arch-full.log
          ./dotfiles.sh --install --profile arch-desktop --dry-run --skip-os-detection -v 2>&1 | tee arch-desktop-full.log

          # Extract only symlink-related operations for comparison
          grep "Would link" base-full.log | sort > base-symlinks.log || true
          grep "Would link" arch-full.log | sort > arch-symlinks.log || true
          grep "Would link" arch-desktop-full.log | sort > arch-desktop-symlinks.log || true

      - name: Verify profiles link different files
        run: ./.github/workflows/scripts/verify/verify-profile-differences.sh

  # Test pre-commit hook functionality
  test-git-hooks:
    name: Test Git Hooks
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Configure git
        run: |
          git config user.name "CI Test"
          git config user.email "ci@test.local"

      - name: Install git hooks
        run: |
          ln -sf "$(pwd)/hooks/pre-commit" .git/hooks/pre-commit
          chmod +x .git/hooks/pre-commit

      - name: Run pre-commit hook tests
        run: ./test/linux/test-git-hooks.sh

  # Test Docker image build
  test-docker:
    name: Test Docker Build
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t dotfiles-test .

      - name: Run container smoke test
        run: |
          docker run --rm dotfiles-test sh -c "command -v zsh && echo 'Smoke test passed'"

  # Summary job - require only this one in branch protection
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs:
      - validate-config
      - static-analysis
      - test-applications
      - test-linux-profiles
      - test-linux-idempotency
      - test-linux-uninstall
      - test-windows
      - test-profile-differences
      - test-git-hooks
      - test-docker
    steps:
      - name: Mark CI as successful
        run: echo "All CI jobs passed"
