#compdef dotfiles

# _dotfiles_get_profiles
#
# Dynamically loads profiles from conf/profiles.ini.
# Returns an array of "profile:description" strings suitable for _describe.
_dotfiles_get_profiles() {
  local -a profiles
  local profile_file="${0:A:h:h:h:h:h}/conf/profiles.ini"

  # Profile descriptions mapping
  local -A profile_desc
  profile_desc[base]="Minimal core shell configuration"
  profile_desc[arch]="Arch Linux headless"
  profile_desc[arch-desktop]="Arch Linux desktop"
  profile_desc[desktop]="Generic desktop"
  profile_desc[windows]="Windows environment"

  # Read profiles from profiles.ini if it exists
  if [[ -f "$profile_file" ]]; then
    while IFS= read -r line; do
      # Extract section headers [profile-name]
      if [[ $line =~ '^\[([^]]+)\]$' ]]; then
        local profile="${match[1]}"
        local desc="${profile_desc[$profile]:-$profile}"
        profiles+=("${profile}:${desc}")
      fi
    done < "$profile_file"
  else
    # Fallback to hardcoded profiles if file not found
    profiles=(
      "base:Minimal core shell configuration"
      "arch:Arch Linux headless"
      "arch-desktop:Arch Linux desktop"
      "desktop:Generic desktop"
      "windows:Windows environment"
    )
  fi

  _describe 'profile' profiles
}

_dotfiles() {
  local curcontext="$curcontext" state line
  typeset -A opt_args

  local -a main_options
  main_options=(
    '(- *)'-h'[Display usage]'
    '(- *)--help[Display usage]'
    '(--install -T --test -U --uninstall -h --help)'-I'[Install dotfiles]'
    '(-I -T --test -U --uninstall -h --help)--install[Install dotfiles]'
    '(-I --install --test -U --uninstall -h --help)'-T'[Run tests]'
    '(-I --install -T -U --uninstall -h --help)--test[Run tests]'
    '(-I --install -T --test --uninstall -h --help)'-U'[Uninstall dotfiles]'
    '(-I --install -T --test -U -h --help)--uninstall[Uninstall dotfiles]'
  )

  local -a install_options
  install_options=(
    '--profile[Select profile]:profile:_dotfiles_get_profiles'
    '--dry-run[Preview changes without system modifications]'
    '--skip-os-detection[Skip automatic OS detection overrides]'
    '-v[Enable verbose logging]'
  )

  local -a test_options
  test_options=(
    '-v[Enable verbose logging]'
  )

  # Determine which action is being invoked
  local action
  for word in "${words[@]}"; do
    case "$word" in
      -I|--install) action="install"; break ;;
      -T|--test) action="test"; break ;;
      -U|--uninstall) action="uninstall"; break ;;
    esac
  done

  case "$action" in
    install|uninstall)
      _arguments -s -S \
        "$main_options[@]" \
        "$install_options[@]"
      ;;
    test)
      _arguments -s -S \
        "$main_options[@]" \
        "$test_options[@]"
      ;;
    *)
      _arguments -s -S "$main_options[@]"
      ;;
  esac
}
