#compdef dotfiles dotfiles.sh

# Zsh completion for the dotfiles CLI (Rust binary).
#
# Commands:  install, uninstall, test, version
# Global:    -v/--verbose, -p/--profile, -d/--dry-run, --root
# Install:   --skip, --only
# Wrapper:   --build  (dotfiles.sh only)

_dotfiles_get_profiles() {
  local -a profiles
  local profile_file="${0:A:h:h:h:h:h}/conf/profiles.ini"

  local -A profile_desc
  profile_desc[base]="Minimal core shell configuration"
  profile_desc[arch]="Arch Linux headless"
  profile_desc[arch-desktop]="Arch Linux desktop"
  profile_desc[desktop]="Generic Linux desktop"
  profile_desc[windows]="Windows environment"

  if [[ -f "$profile_file" ]]; then
    while IFS= read -r line; do
      if [[ $line =~ '^\[([^]]+)\]$' ]]; then
        local profile="${match[1]}"
        local desc="${profile_desc[$profile]:-$profile}"
        profiles+=("${profile}:${desc}")
      fi
    done < "$profile_file"
  else
    profiles=(
      "base:Minimal core shell configuration"
      "arch:Arch Linux headless"
      "arch-desktop:Arch Linux desktop"
      "desktop:Generic Linux desktop"
      "windows:Windows environment"
    )
  fi

  _describe 'profile' profiles
}

_dotfiles() {
  local curcontext="$curcontext" state line
  typeset -A opt_args

  local -a global_options
  global_options=(
    '(-v --verbose)'{-v,--verbose}'[Enable verbose output]'
    '(-p --profile)'{-p,--profile}'[Profile to use]:profile:_dotfiles_get_profiles'
    '(-d --dry-run)'{-d,--dry-run}'[Preview changes without applying]'
    '--root[Override dotfiles root directory]:directory:_directories'
    '--build[Build from source instead of downloading binary (dotfiles.sh only)]'
    '(- *)'{-h,--help}'[Display help]'
  )

  local -a commands
  commands=(
    'install:Install dotfiles and configure system'
    'uninstall:Remove installed dotfiles'
    'test:Run self-tests and validation'
    'version:Print version information'
  )

  _arguments -s -S -C \
    "$global_options[@]" \
    '1:command:->command' \
    '*::arg:->args'

  case "$state" in
    command)
      _describe 'command' commands
      ;;
    args)
      case "${line[1]}" in
        install)
          _arguments -s -S \
            '--skip[Skip specific tasks]:tasks:' \
            '--only[Run only specific tasks]:tasks:' \
            "$global_options[@]"
          ;;
        uninstall|test|version)
          _arguments -s -S "$global_options[@]"
          ;;
      esac
      ;;
  esac
}
