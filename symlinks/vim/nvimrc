" Neovim-specific configuration
" This file is sourced after the main vimrc

" Terminal navigation
augroup NeovimTerminal
  autocmd!
  autocmd BufWinEnter,WinEnter term://* startinsert
  autocmd BufLeave term://* stopinsert
augroup END

tnoremap <esc> <C-\><C-n><C-w><C-p>

" <C-h> fix for tmux-navigator
" Neovim terminal mode requires this specific mapping for proper tmux integration
" Overrides the simpler mapping in vimrc (line 193: nnoremap <BS> <C-W>h)
nnoremap <bs> :<c-u>TmuxNavigateLeft<cr>

" Open terminal
noremap <leader>t :terminal<cr>

" Plugin loading: lazy.nvim for Neovim
lua << EOF
  -- Bootstrap and configure lazy.nvim
  pcall(function()
    require('lazy-bootstrap')
  end)
EOF

" Lua configuration for Neovim plugins
lua << EOF
-- Helper to check if a module exists
local function module_exists(name)
  if package.loaded[name] then
    return true
  else
    for _, searcher in ipairs(package.searchers or package.loaders) do
      local loader = searcher(name)
      if type(loader) == 'function' then
        package.preload[name] = loader
        return true
      end
    end
    return false
  end
end

-- Setup nvim-tree (modern file explorer) if available
if module_exists('nvim-tree') then
  pcall(function()
    require('nvim-tree').setup({
      disable_netrw = true,
      hijack_netrw = true,
      view = {
        width = 30,
        side = 'right',
      },
      renderer = {
        icons = {
          show = {
            file = true,
            folder = true,
            folder_arrow = true,
            git = true,
          },
        },
      },
      filters = {
        dotfiles = false,
      },
    })
  end)
end

-- Setup lualine (modern statusline) if available
if module_exists('lualine') then
  pcall(function()
    require('lualine').setup({
      options = {
        theme = 'tokyonight',
        component_separators = '',
        section_separators = { left = '', right = '' },
        globalstatus = true,
      },
      sections = {
        lualine_a = { { 'mode', separator = { left = '' }, right_padding = 2 } },
        lualine_b = { 'branch', 'diff', 'diagnostics' },
        lualine_c = { { 'filename', path = 1 } },
        lualine_x = { 'encoding', 'fileformat' },
        lualine_y = { 'filetype' },
        lualine_z = { { 'location', separator = { right = '' }, left_padding = 2 } }
      },
      tabline = {
        lualine_a = {},
        lualine_b = {},
        lualine_c = { { 'tabs', mode = 1, max_length = vim.o.columns } },
        lualine_x = {},
        lualine_y = {},
        lualine_z = {}
      },
    })
  end)
end

-- Setup treesitter for better syntax highlighting if available
if module_exists('nvim-treesitter.configs') then
  pcall(function()
    require('nvim-treesitter.configs').setup({
      ensure_installed = {
        'python', 'javascript', 'typescript', 'lua', 'vim', 'vimdoc',
        'rust', 'go', 'c', 'cpp', 'java', 'haskell', 'bash',
        'json', 'yaml', 'toml', 'markdown', 'markdown_inline'
      },
      highlight = {
        enable = true,
        additional_vim_regex_highlighting = false,
      },
      indent = {
        enable = true,
      },
      incremental_selection = {
        enable = true,
        keymaps = {
          init_selection = '<CR>',
          scope_incremental = '<CR>',
          node_incremental = '<TAB>',
          node_decremental = '<S-TAB>',
        },
      },
    })
  end)
end
EOF

" Key mappings for Neovim plugins
" Only map NvimTreeToggle if nvim-tree is available
if exists(':NvimTreeToggle')
  nnoremap <silent><c-e> :NvimTreeToggle<cr>
endif
